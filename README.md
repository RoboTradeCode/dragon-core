# Test Core Python
## Ядро для тестирования гейтов

Ядро предназначено для тестирования гейтов. Его запуск осуществляется через простой CLI-интерфейс, есть несколько типов тестирования. Ядро написано на Python3.10 с использованием библиотека aeron-python и click. 

### Типы тестирования

####  Fast Test

Тип тестирования, при котором ядро **прогоняет все команды** и тестирует выставление и отмену ордеров, получение баланса и ордербуков. То есть тестируется **весь функционал**, но максимально **быстро**. Данный тест будет использоваться при **незначительных изменениях** гейта для **проверки его работоспособности**.     

Обозначаенися в cli как `fast-test`

####  Long Test

 При этом тестировании ядро запускается на **продолжительное время** (несколько дней) и реализует простую безубыточную **торговую стратегию**. Основная цель такого тестирования - проверить, как **гейт конкретной биржи** ведет себя при **продолжительном запуске**. Тест будет использоваться для проверки новых гейтов, гейтов со  значительными изменениями или для гейтов, адаптированных под новые  биржи.

Обозначаенися в cli как `long-test`

#### Listener

Режим запуска ядра, при котором оно не будет отправлять команды, а будет только получать сообщения от гейта и логгировать их. По сути, это не является тестом, а особым режимом работы ядра.

Обозначаенися в cli как `listener`

## Установка

1. Установка python 3.10:
    ```bash
    sudo apt update && sudo apt upgrade -y
    sudo apt install software-properties-common -y
    sudo add-apt-repository ppa:deadsnakes/ppa -y
    sudo apt install python3.10 python3.10-dev python3.10-venv
    ```

2. Клонирование репозитория с исходным кодом ядра:
	```bash
	git clone https://github.com/RoboTradeCode/test-core-python.git
	```
	
3. Установка виртуального окружения venv:
	```bash
	cd test-core-python
	python3.10 -m venv venv
	```
4. Активация виртуального окружения:
	```bash
	source venv/bin/activate
	```

5. Установка зависимостей ядра:
	```bash
	pip install -r requirements.txt
	```
6. Добавление права на запуск:

	```bash
	sudo chmod +x run_test_core.py
	```

7. Основные этапы установки завершены. Также для работы ядра потребуется Aeron. На момент запуска должен быть запущен Media Drive Aeron. Он может быть запущен как в качестве systemd, так и в качестве процесса (т.е. запущен в терминале). Инстркуции по сборке и запуску Aeron можно найти в вики [aeron-python](https://github.com/RoboTradeCode/aeron-python/wiki/%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-Aeron).

8. Рекомендую запустить ядро в целях проверки:
	```bash
	python run_test_core.py listener binance
	```
	
## Использование
Тестовое ядро реализует несложный интерфейс команной строки. Запуск ядра в определенном режиме (см. типы тестирования) можно выполнить с помощью команд такого формата:

```bash
./run_test_core.py <тип тестирования> <название биржи>
```

Например:
```bash
./run_test_core.py fast-test binance
```
```bash
./run_test_core.py listener okx
```
```bash
./run_test_core.py long-test ftx
```

При выполнении такой команды в терминале, будет запущено тестовое ядро. Вывод логов будет осуществляться в этот  же терминал. Остановить ядро можно с помощью прерывания Ctrl + C.

### Пример запуска в PyCharm

Чтобы запускать ядро и гейт одновременно, в PyCharm их можно объединить в **Compound**. Предполагаю, аналогично можно запускать и в других IDE от JetBrains: CLion, PhpStorm.

![Пример запуска ядра в PyCharm](https://user-images.githubusercontent.com/66905267/169645346-3ec33369-afc7-4f5b-8029-f2a22355e5ea.png)

1. Нужно создать новую конфигурацию **Python**. Эта конфигурация отвечает за запуск одного из видов тестирования. Я рекомендую сделать несколько конфигураций **Python**, на каждый тип тестирования, и объединить их в разные конфигурации **Compound**.
2. В качестве скрипта для запуска указывайте `run_test_core.py`. Этот скрипт отвечает за запуск ядра и CLI интерфейс.
3. Чтобы запустить один из типов тестирования, его нужно указать в Parameters. В примере это `fast-test` для биржи `kucoin`. К слову, не обязательно указывать настоящее название биржи, однако это позволит избежать путаницы - название будет указываться в сообщениях, которые отправляет ядро.
4. Объедините конфигурации **гейта** и **тестового ядра** в **Compound**. После этого вы можете выбирать для запуска конфигурацию **Compound** и запускать одновременно и гейт, и тестовое ядро.

### Логи ядра
Ядро будет логгировать происходящие действия. Ниже приведет пример лога во время Fast Test.

> На данный момент ядро помечает `order_status` как `warning: unexpected data`. Можете игнорировать, в будущих обновлениях это будет исправлено.

![image](https://user-images.githubusercontent.com/66905267/169647762-1954857b-0d3a-4a9c-8aad-ccc67348cb9b.png)

## Настройки
Сейчас ядро не имеет файла настроек. При необходимости, вы можете изменять исходный код ядра. В будущем настройки планируется вынести в отдельный файл.

### Aeron

Настройки защиты в исходный код и соответствуют [общему правилу выбора stream_id при настройке Aeron](https://github.com/RoboTradeCode/configurator/wiki/%D0%9E%D0%B1%D1%89%D0%B5%D0%B5-%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D0%BB%D0%BE-%D0%B2%D1%8B%D0%B1%D0%BE%D1%80%D0%B0-stream_id-%D0%BF%D1%80%D0%B8-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B5-Aeron). Дублирую таблицу ниже:


| **название**         | **Название поля json** | **отправитель** | **получатель** | **stream_id** |
| -------------------- | ---------------------- | --------------- | -------------- | ------------- |
| запрос конфигов      | agent                  | гейт            | агент          | 1001          |
| запрос конфигов      | agent                  | ядро            | агент          | 1002          |
| отправление конфигов |                        | агент           | гейт и ядро    | 1003          |
| команды              | core                   | ядро            | гейт           | 1004          |
| баланс               | balances               | гейт            | ядро           | 1005          |
| ордербуки            | orderbooks             | гейт            | ядро           | 1006          |
| статусы ордера       | orders_statuses        | гейт            | ядро           | 1007          |
| логи                 | logs                   | гейт и ядро     | агент          | 1008          |
